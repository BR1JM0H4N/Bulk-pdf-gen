<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Simple PDF Editor (Vanilla JS)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    #controls { margin-bottom: 1em; }
    #text-controls { margin-top: 1em; margin-bottom: 1em;}
    .text-item { padding: 1em; border: 1px solid #ccc; margin-bottom: 0.5em; }
    .inline { display: inline-block; margin-right: 1em; }
    #pdf-canvas { border: 1px solid #333; background: #f8f8f8; }
    label { margin-right: 0.5em; }
    input[type="color"] { vertical-align: middle; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>
  eruda.init();
</script>
</head>
<body>
  <h2>Simple PDF Editor (Live Preview)</h2>
  <div id="controls">
    <input type="file" id="pdf-upload" accept="application/pdf">
    <button id="add-text-btn" disabled>Add Text</button>
  </div>

  <div id="text-controls"></div>

  <h3>Live Preview (First Page)</h3>
  <canvas id="pdf-canvas" width="600" height="800"></canvas>

  <!-- PDF.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script>
    // PDF.js worker setup:
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";

    const pdfUpload = document.getElementById('pdf-upload');
    const addTextBtn = document.getElementById('add-text-btn');
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const textCtrls = document.getElementById('text-controls');

    let pdfDoc = null, pageNum = 1, page = null, renderScale = 1.5, pdfWidth=0, pdfHeight=0, renderTask = null;
    let textOverlays = [];

    // Helper: Redraw the page & overlays
    function redraw() {
      if (!page) return;
      // Render page
      renderTask = page.render({
        canvasContext: ctx,
        viewport: page.getViewport({ scale: renderScale }),
      });
      renderTask.promise.then(() => {
        // Draw each text overlay
        textOverlays.forEach(ov => {
          ctx.save();
          ctx.font = `${ov.fontSize}px Arial`;
          ctx.fillStyle = ov.color;
          ctx.textBaseline = "top";
          let x = ov.x, anchor = ov.anchor, textWidth = ctx.measureText(ov.text).width;
          // Anchor handling:
          if (anchor === "center") x -= textWidth/2;
          if (anchor === "right") x -= textWidth;
          ctx.fillText(ov.text, x, ov.y);
          ctx.restore();
        });
      });
    }

    // Helper: Render the pdf's first page to canvas
    function renderPdfFirstPage(pdfData) {
      pdfjsLib.getDocument({ data: pdfData }).promise.then(function(pdfDoc_) {
        pdfDoc = pdfDoc_;
        pdfDoc.getPage(pageNum).then(function(page_) {
          page = page_;
          let viewport = page.getViewport({ scale: renderScale });
          pdfWidth = canvas.width = viewport.width|0;
          pdfHeight = canvas.height = viewport.height|0;
          redraw();
        });
      });
    }

    // When user uploads PDF
    pdfUpload.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function() {
        renderPdfFirstPage(new Uint8Array(reader.result));
        addTextBtn.disabled = false;
        textOverlays = [];
        textCtrls.innerHTML = '';
      };
      reader.readAsArrayBuffer(file);
    });

    // Add text overlay UI
    addTextBtn.addEventListener('click', function() {
      if (!pdfDoc) return;
      const defaultText = `Text #${textOverlays.length+1}`;
      let overlay = {
        text: defaultText,
        fontSize: 24,
        color: '#d13b3b',
        x: 60,
        y: 60 + 40*textOverlays.length,
        anchor: "left"
      };
      textOverlays.push(overlay);

      // Create UI for this overlay
      const idx = textOverlays.length-1;
      const item = document.createElement('div');
      item.className = "text-item";
      item.innerHTML = `
        <label>Text: <input type="text" value="${overlay.text}" class="text-input"></label>
        <label>Font size: <input type="number" min="8" max="200" value="${overlay.fontSize}" class="font-size-input" style="width:60px"></label>
        <label>Color: <input type="color" value="${overlay.color}" class="color-input"></label><br>
        <label class="inline">X: <input type="number" min="0" max="10000" value="${overlay.x}" class="x-input" style="width:60px"></label>
        <label class="inline">Y: <input type="number" min="0" max="10000" value="${overlay.y}" class="y-input" style="width:60px"></label>
        <label class="inline">Anchor: 
          <select class="anchor-input">
            <option value="left">Left</option>
            <option value="center">Center</option>
            <option value="right">Right</option>
          </select>
        </label>
        <button class="remove-btn" style="float:right;">ðŸ—‘ Remove</button>
      `;
      textCtrls.appendChild(item);

      // Wire events for all inputs
      const [textInput, fontSizeInput, colorInput, xInput, yInput, anchorInput, removeBtn] =
        item.querySelectorAll('.text-input, .font-size-input, .color-input, .x-input, .y-input, .anchor-input, .remove-btn');

      textInput.addEventListener('input', e => { overlay.text = textInput.value; redraw(); });
      fontSizeInput.addEventListener('input', e => { overlay.fontSize = parseInt(fontSizeInput.value)||12; redraw(); });
      colorInput.addEventListener('input', e => { overlay.color = colorInput.value; redraw(); });
      xInput.addEventListener('input', e => { overlay.x = parseInt(xInput.value)||0; redraw(); });
      yInput.addEventListener('input', e => { overlay.y = parseInt(yInput.value)||0; redraw(); });
      anchorInput.addEventListener('change', e => { overlay.anchor = anchorInput.value; redraw(); });
      anchorInput.value = overlay.anchor;
      removeBtn.addEventListener('click', function(e) {
        textOverlays.splice(idx,1);
        textCtrls.removeChild(item);
        redraw();
      });

      redraw();
    });
  </script>
</body>
</html>
