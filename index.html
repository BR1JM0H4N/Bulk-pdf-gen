<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>CertMaker — Professional Generator</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg: #0f172a;
      --panel: #1e293b;
      --border: #334155;
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --danger: #ef4444;
      --success: #22c55e;
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      margin: 0; height: 100vh;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      display: flex; flex-direction: column;
      overflow: hidden; /* App-like feel */
    }

    /* Header */
    header {
      height: 60px; padding: 0 20px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      display: flex; align-items: center; justify-content: space-between;
      flex-shrink: 0;
    }
    header h1 { font-size: 18px; font-weight: 700; color: #fff; margin: 0; }
    .badge { font-size: 11px; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 12px; color: var(--text-muted); }

    /* Main Layout */
    main {
      flex: 1; display: flex; overflow: hidden;
    }

    /* Sidebar (Controls) */
    .sidebar {
      width: 380px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      overflow-y: auto;
      flex-shrink: 0;
      padding-bottom: 40px;
    }

    /* Responsive Mobile */
    @media (max-width: 900px) {
      main { flex-direction: column; }
      .sidebar { width: 100%; height: 40%; border-right: none; border-bottom: 1px solid var(--border); order: 2; }
      .preview-area { height: 60%; order: 1; }
    }

    .section { padding: 16px; border-bottom: 1px solid var(--border); }
    .section h3 { margin: 0 0 12px 0; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); }

    /* Form Elements */
    label { display: block; font-size: 13px; margin-bottom: 6px; color: var(--text-muted); }
    input[type=text], input[type=number], select, textarea {
      width: 100%; background: #0f172a; border: 1px solid var(--border);
      color: white; padding: 8px 12px; border-radius: 6px; font-size: 14px;
      font-family: inherit; transition: 0.2s;
    }
    textarea { font-family: 'JetBrains Mono', monospace; min-height: 100px; resize: vertical; }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); }

    /* Custom File Input */
    .file-drop {
      border: 2px dashed var(--border); border-radius: 8px;
      padding: 16px; text-align: center; cursor: pointer; transition: 0.2s;
      position: relative;
    }
    .file-drop:hover { border-color: var(--primary); background: rgba(99,102,241,0.05); }
    .file-drop input { position: absolute; inset:0; opacity:0; cursor:pointer; }
    .file-drop span { font-size: 13px; color: var(--text-muted); pointer-events: none; }

    /* Buttons */
    .btn-row { display: flex; gap: 8px; margin-top: 10px; }
    button {
      flex: 1; padding: 8px 16px; border-radius: 6px; border: none;
      font-weight: 600; font-size: 13px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 6px;
      transition: 0.2s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-sec { background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid var(--border); }
    .btn-sec:hover { background: rgba(255,255,255,0.1); }
    .btn-danger { background: rgba(239,68,68,0.1); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }
    .btn-danger:hover { background: var(--danger); color: white; }

    /* Field List */
    .field-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
    .field-item {
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(255,255,255,0.03); padding: 8px 12px; border-radius: 6px;
      font-size: 13px;
    }
    .field-name { font-weight: 600; font-family: 'JetBrains Mono', monospace; color: #cbd5e1; }
    .status-placed { color: var(--success); font-size: 11px; margin-right: 6px; }

    /* Preview Area */
    .preview-area {
      flex: 1; background: #0b101e;
      position: relative; overflow: auto;
      display: flex; justify-content: center; align-items: flex-start;
      padding: 40px;
    }
    
    /* The Wrapper for Canvas + Overlay */
    #canvas-wrapper {
      position: relative;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      border-radius: 4px;
      /* Initial placeholder size */
      width: 0; height: 0; 
    }

    canvas { display: block; background: white; border-radius: 2px; }

    /* The Overlay that sits exactly on top */
    #overlay {
      position: absolute; inset: 0;
      z-index: 10; overflow: hidden;
      /* Pass clicks through unless we hit a placeholder */
      pointer-events: none; 
    }
    
    /* Placeholders */
    .placeholder {
      position: absolute;
      padding: 4px 8px;
      background: rgba(99, 102, 241, 0.2);
      border: 1px dashed var(--primary);
      color: var(--primary);
      font-weight: bold;
      font-size: 14px;
      cursor: grab;
      user-select: none;
      pointer-events: auto; /* Catch events */
      border-radius: 4px;
      white-space: nowrap;
      transform: translate(0, -100%); /* Anchor bottom-left logic visually */
    }
    
    .placeholder.selected {
      background: rgba(99, 102, 241, 0.9);
      color: white;
      border: 1px solid white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 20;
    }
    
    .placeholder:active { cursor: grabbing; }

    /* Utilities */
    .hidden { display: none; }
    .empty-state { color: var(--text-muted); text-align: center; margin-top: 100px; }
  </style>
</head>
<body>

  <header>
    <h1>CertMaker <span style="font-weight:400; opacity:0.7">Editor</span></h1>
    <div class="badge">Client-side Only • Secure</div>
  </header>

  <main>
    <div class="sidebar">
      
      <div class="section">
        <h3>1. Template</h3>
        <div class="file-drop" onclick="document.getElementById('pdfFile').click()">
          <span id="pdfFileName">Click to upload PDF Template</span>
          <input type="file" id="pdfFile" accept="application/pdf">
        </div>
        <div style="margin-top:8px">
          <label>Optional: Custom Font (TTF/OTF)</label>
          <input type="file" id="fontFile" accept=".ttf,.otf" style="font-size:12px">
        </div>
      </div>

      <div class="section">
        <h3>2. Data</h3>
        <label>Paste JSON Data (Array of Students)</label>
        <textarea id="jsonInput" placeholder='{"students":[ {"Name":"Alex Doe", "Date":"2024-05-20"} ]}'></textarea>
        <div class="btn-row">
          <button class="btn-sec" id="loadJson">Process JSON</button>
          <button class="btn-sec" id="sampleJson">Load Sample</button>
        </div>
        
        <div id="fieldsContainer" class="hidden" style="margin-top:16px">
          <label>Available Fields</label>
          <div class="field-list" id="fieldList"></div>
          <small style="color:var(--text-muted); display:block; margin-top:8px; line-height:1.4">
            Click <strong>Place</strong>, then click on the document. Drag to position.
          </small>
        </div>
      </div>

      <div id="selectionControls" class="section hidden" style="background:rgba(99,102,241,0.05); border-left:4px solid var(--primary)">
        <h3>Selected: <span id="selName" style="color:white"></span></h3>
        <div class="btn-row">
          <div style="flex:1">
            <label>Size</label>
            <input type="number" id="selSize" value="20">
          </div>
          <div style="flex:1">
            <label>Align</label>
            <select id="selAlign">
              <option value="left">Left</option>
              <option value="center">Center</option>
              <option value="right">Right</option>
            </select>
          </div>
        </div>
        <div class="btn-row">
            <div style="flex:1">
                <label>Color</label>
                <input type="color" id="selColor" value="#000000" style="height:36px; padding:2px">
            </div>
            <div style="flex:1"></div>
        </div>
        <div class="btn-row" style="margin-top:12px">
          <button class="btn-danger" id="deleteSel">Remove</button>
        </div>
      </div>

      <div class="section">
        <h3>3. Export</h3>
        <div class="btn-row">
          <button class="btn-sec" id="previewBtn">Preview PDF</button>
        </div>
        <div class="btn-row">
          <button class="btn-primary" id="generateBtn">Download All (PDFs)</button>
          <button class="btn-sec" id="generateZip">Download ZIP</button>
        </div>
        <div class="btn-row" style="margin-top:12px">
            <button class="btn-sec" style="font-size:11px" id="saveConfig">Save Template Config</button>
            <button class="btn-sec" style="font-size:11px" id="loadConfig">Load Config</button>
            <input type="file" id="configInput" accept=".json" style="display:none">
        </div>
      </div>
      
    </div>

    <div class="preview-area" id="scrollContainer">
      <div class="empty-state" id="emptyState">
        <h2>No Template Loaded</h2>
        <p>Upload a PDF in the sidebar to begin.</p>
      </div>

      <div id="canvas-wrapper">
        <canvas id="pdfCanvas"></canvas>
        <div id="overlay"></div>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
  <script src="https://unpkg.com/@pdf-lib/fontkit@0.0.4/dist/fontkit.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    /** App State **/
    const App = {
      pdfBytes: null,
      customFontBytes: null,
      students: [],
      fields: [],
      // placeholders: { fieldName: { xPercent, yPercent, size, align, color, element } }
      placeholders: {},
      selectedField: null,
      isPlacing: null, // fieldName currently being placed
      scale: 1.5 // Render scale for sharpness
    };

    /** DOM Elements **/
    const UI = {
      pdfFile: document.getElementById('pdfFile'),
      fontFile: document.getElementById('fontFile'),
      jsonInput: document.getElementById('jsonInput'),
      loadJson: document.getElementById('loadJson'),
      sampleJson: document.getElementById('sampleJson'),
      fieldList: document.getElementById('fieldList'),
      fieldsContainer: document.getElementById('fieldsContainer'),
      canvas: document.getElementById('pdfCanvas'),
      overlay: document.getElementById('overlay'),
      wrapper: document.getElementById('canvas-wrapper'),
      emptyState: document.getElementById('emptyState'),
      selControls: document.getElementById('selectionControls'),
      // Controls
      selName: document.getElementById('selName'),
      selSize: document.getElementById('selSize'),
      selAlign: document.getElementById('selAlign'),
      selColor: document.getElementById('selColor'),
      deleteSel: document.getElementById('deleteSel'),
      // Actions
      previewBtn: document.getElementById('previewBtn'),
      generateBtn: document.getElementById('generateBtn'),
      generateZip: document.getElementById('generateZip'),
      saveConfig: document.getElementById('saveConfig'),
      loadConfig: document.getElementById('loadConfig'),
      configInput: document.getElementById('configInput'),
    };

    /** 1. PDF Loading & Rendering **/
    UI.pdfFile.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      
      document.getElementById('pdfFileName').textContent = file.name;
      App.pdfBytes = await file.arrayBuffer();
      
      // Render Preview
      const loadingTask = pdfjsLib.getDocument({ data: App.pdfBytes });
      const pdf = await loadingTask.promise;
      const page = await pdf.getPage(1);
      
      const viewport = page.getViewport({ scale: App.scale });
      
      // Set dimensions
      UI.canvas.width = viewport.width;
      UI.canvas.height = viewport.height;
      UI.wrapper.style.width = (viewport.width / App.scale) + 'px'; // CSS pixels
      UI.wrapper.style.height = (viewport.height / App.scale) + 'px'; // CSS pixels
      UI.canvas.style.width = '100%';
      UI.canvas.style.height = '100%';

      const ctx = UI.canvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport }).promise;

      UI.emptyState.style.display = 'none';
      UI.wrapper.style.display = 'block';
    });

    UI.fontFile.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if(file) {
        App.customFontBytes = await file.arrayBuffer();
        alert("Custom font loaded!");
      }
    });

    /** 2. JSON Handling **/
    UI.sampleJson.addEventListener('click', () => {
      UI.jsonInput.value = JSON.stringify({
        students: [
          { "Name": "John Doe", "Course": "Web Development", "Date": "2024-01-15", "Grade": "A" },
          { "Name": "Jane Smith", "Course": "Data Science", "Date": "2024-02-20", "Grade": "A+" }
        ]
      }, null, 2);
    });

    UI.loadJson.addEventListener('click', () => {
      try {
        const data = JSON.parse(UI.jsonInput.value);
        if(!data.students || !Array.isArray(data.students)) throw new Error("JSON must have a root 'students' array.");
        App.students = data.students;
        
        // Extract keys
        const keys = new Set();
        App.students.forEach(s => Object.keys(s).forEach(k => keys.add(k)));
        App.fields = Array.from(keys);
        
        renderFieldList();
        UI.fieldsContainer.classList.remove('hidden');
      } catch (err) {
        alert("Error parsing JSON: " + err.message);
      }
    });

    function renderFieldList() {
      UI.fieldList.innerHTML = '';
      App.fields.forEach(field => {
        const isPlaced = App.placeholders[field] !== undefined;
        const div = document.createElement('div');
        div.className = 'field-item';
        div.innerHTML = `
          <span class="field-name">${field}</span>
          <div>
            ${isPlaced ? '<span class="status-placed">✓ Placed</span>' : ''}
            <button class="btn-sec" style="padding:4px 8px; font-size:11px" onclick="startPlacing('${field}')">
              ${isPlaced ? 'Move' : 'Place'}
            </button>
          </div>
        `;
        UI.fieldList.appendChild(div);
      });
    }

    /** 3. Placement Logic (The Core Fix) **/
    window.startPlacing = (field) => {
      App.isPlacing = field;
      UI.wrapper.style.cursor = 'crosshair';
      // Provide visual feedback
      UI.overlay.style.backgroundColor = 'rgba(99,102,241,0.1)';
    };

    // Click on overlay to drop the placeholder
    UI.overlay.addEventListener('click', (e) => {
      if(!App.isPlacing) return;

      const rect = UI.overlay.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // Convert to percentages (0.0 to 1.0) for resolution independence
      const xPercent = x / rect.width;
      const yPercent = y / rect.height;

      createOrUpdatePlaceholder(App.isPlacing, xPercent, yPercent);
      
      // Reset state
      App.isPlacing = null;
      UI.wrapper.style.cursor = 'default';
      UI.overlay.style.backgroundColor = 'transparent';
      renderFieldList(); // Update "Placed" checkmark
    });

    function createOrUpdatePlaceholder(field, xPct, yPct, config = {}) {
      // Remove existing DOM if any
      if(App.placeholders[field]) {
        App.placeholders[field].element.remove();
      }

      const el = document.createElement('div');
      el.className = 'placeholder';
      el.textContent = field;
      
      // Default styles or restored config
      const size = config.size || 20;
      const color = config.color || '#000000';
      const align = config.align || 'left';

      // Store state
      App.placeholders[field] = {
        xPercent: xPct,
        yPercent: yPct,
        size, color, align,
        element: el
      };

      // Apply initial Position
      updateElementStyle(field);

      // Add Interaction
      el.addEventListener('mousedown', (e) => onDragStart(e, field));
      el.addEventListener('touchstart', (e) => onDragStart(e, field), {passive: false});
      el.addEventListener('click', (e) => { e.stopPropagation(); selectPlaceholder(field); });

      UI.overlay.appendChild(el);
      selectPlaceholder(field);
    }

    function updateElementStyle(field) {
      const p = App.placeholders[field];
      const el = p.element;
      
      // Visual Position based on container size
      el.style.left = (p.xPercent * 100) + '%';
      el.style.top = (p.yPercent * 100) + '%';
      
      // Visual styling
      // Note: We don't scale font size visually perfectly to PDF, 
      // but we give a good approximation relative to screen width.
      el.style.fontSize = p.size + 'px'; 
      el.style.color = p.color;
      
      // Alignment visual adjustment (CSS transform)
      // We anchor top-left of the div to the point.
      // PDF-Lib draws text baseline. 
      // To simulate "Text flows from this point":
      if(p.align === 'center') el.style.transform = 'translate(-50%, -100%)';
      else if(p.align === 'right') el.style.transform = 'translate(-100%, -100%)';
      else el.style.transform = 'translate(0, -100%)'; // Left align, anchor bottom-left
    }

    /** 4. Selection & Editing **/
    function selectPlaceholder(field) {
      App.selectedField = field;
      
      // Highlight UI
      document.querySelectorAll('.placeholder').forEach(el => el.classList.remove('selected'));
      App.placeholders[field].element.classList.add('selected');

      // Populate Controls
      const p = App.placeholders[field];
      UI.selName.textContent = field;
      UI.selSize.value = p.size;
      UI.selAlign.value = p.align;
      UI.selColor.value = p.color;
      UI.selControls.classList.remove('hidden');
    }

    // Live Edit Listeners
    UI.selSize.addEventListener('input', (e) => {
      if(App.selectedField) {
        App.placeholders[App.selectedField].size = parseInt(e.target.value);
        updateElementStyle(App.selectedField);
      }
    });
    UI.selColor.addEventListener('input', (e) => {
      if(App.selectedField) {
        App.placeholders[App.selectedField].color = e.target.value;
        updateElementStyle(App.selectedField);
      }
    });
    UI.selAlign.addEventListener('change', (e) => {
      if(App.selectedField) {
        App.placeholders[App.selectedField].align = e.target.value;
        updateElementStyle(App.selectedField);
      }
    });
    UI.deleteSel.addEventListener('click', () => {
      if(App.selectedField) {
        App.placeholders[App.selectedField].element.remove();
        delete App.placeholders[App.selectedField];
        UI.selControls.classList.add('hidden');
        renderFieldList();
      }
    });

    /** 5. Drag & Drop System (Mouse + Touch) **/
    function onDragStart(e, field) {
      // Prevent default to stop scrolling on touch
      if(e.type === 'touchstart') e.preventDefault();
      
      const p = App.placeholders[field];
      const wrapperRect = UI.wrapper.getBoundingClientRect();
      
      // Initial mouse/touch pos
      const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
      const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;

      const onMove = (mv) => {
        mv.preventDefault();
        const moveX = mv.type.includes('mouse') ? mv.clientX : mv.touches[0].clientX;
        const moveY = mv.type.includes('mouse') ? mv.clientY : mv.touches[0].clientY;

        const deltaX = moveX - clientX;
        const deltaY = moveY - clientY;

        // Calculate new Percentage
        // Current Pixel Pos + Delta
        const currentPixX = p.xPercent * wrapperRect.width;
        const currentPixY = p.yPercent * wrapperRect.height;
        
        let newXPct = (currentPixX + deltaX) / wrapperRect.width;
        let newYPct = (currentPixY + deltaY) / wrapperRect.height;

        // Update DOM
        p.element.style.left = (newXPct * 100) + '%';
        p.element.style.top = (newYPct * 100) + '%';
      };

      const onEnd = (end) => {
        // Finalize state
        const endX = end.type.includes('mouse') ? end.clientX : (end.changedTouches ? end.changedTouches[0].clientX : clientX);
        const endY = end.type.includes('mouse') ? end.clientY : (end.changedTouches ? end.changedTouches[0].clientY : clientY);
        
        const deltaX = endX - clientX;
        const deltaY = endY - clientY;

        const currentPixX = p.xPercent * wrapperRect.width;
        const currentPixY = p.yPercent * wrapperRect.height;

        p.xPercent = (currentPixX + deltaX) / wrapperRect.width;
        p.yPercent = (currentPixY + deltaY) / wrapperRect.height;

        // Clamp 0-1
        p.xPercent = Math.max(0, Math.min(1, p.xPercent));
        p.yPercent = Math.max(0, Math.min(1, p.yPercent));

        updateElementStyle(field); // Snap to cleaner css
        selectPlaceholder(field);  // Keep selected

        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onEnd);
        document.removeEventListener('touchmove', onMove);
        document.removeEventListener('touchend', onEnd);
      };

      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onEnd);
      document.addEventListener('touchmove', onMove, {passive: false});
      document.addEventListener('touchend', onEnd);
    }

    /** 6. PDF Generation Logic **/
    async function generatePDF(studentData) {
      if(!App.pdfBytes) return null;
      
      const { PDFDocument, rgb, StandardFonts } = PDFLib;
      const pdfDoc = await PDFDocument.load(App.pdfBytes);
      
      // Register font
      pdfDoc.registerFontkit(fontkit);
      let font;
      if(App.customFontBytes) {
        font = await pdfDoc.embedFont(App.customFontBytes);
      } else {
        font = await pdfDoc.embedFont(StandardFonts.Helvetica);
      }

      const pages = pdfDoc.getPages();
      const firstPage = pages[0];
      const { width, height } = firstPage.getSize();

      // Draw Fields
      for (const [key, p] of Object.entries(App.placeholders)) {
        const text = studentData[key] || "";
        
        // Math: Convert % to PDF Points
        // PDF Coordinates start Bottom-Left. Browser starts Top-Left.
        // X is simple: width * percent
        // Y is inverted: height - (height * percent)
        
        const x = p.xPercent * width;
        const y = height - (p.yPercent * height); // Invert Y
        
        const textSize = p.size; // We assume 1px screen ~= 1pt PDF for simplicity in this editor
        
        // Calculate Text Width for Alignment
        const textWidth = font.widthOfTextAtSize(String(text), textSize);
        
        let drawX = x;
        if(p.align === 'center') drawX = x - (textWidth / 2);
        if(p.align === 'right') drawX = x - textWidth;

        firstPage.drawText(String(text), {
          x: drawX,
          y: y, 
          size: textSize,
          font: font,
          color: hexToRgb(p.color, rgb)
        });
      }

      return await pdfDoc.save();
    }

    function hexToRgb(hex, rgbFunc) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? rgbFunc(
        parseInt(result[1], 16)/255,
        parseInt(result[2], 16)/255,
        parseInt(result[3], 16)/255
      ) : rgbFunc(0,0,0);
    }

    /** 7. Export Buttons **/
    UI.previewBtn.addEventListener('click', async () => {
      if(!App.pdfBytes) return alert("Upload PDF first.");
      if(!App.students.length) return alert("Load JSON first.");
      
      const bytes = await generatePDF(App.students[0]);
      const blob = new Blob([bytes], { type: "application/pdf" });
      window.open(URL.createObjectURL(blob), "_blank");
    });

    UI.generateBtn.addEventListener('click', async () => {
      if(!App.pdfBytes) return alert("Upload PDF first.");
      
      // Loop all students
      for(let i=0; i<App.students.length; i++) {
        const s = App.students[i];
        const bytes = await generatePDF(s);
        const blob = new Blob([bytes], { type: "application/pdf" });
        saveAs(blob, `${s.Name || 'Certificate'}-${i+1}.pdf`);
      }
    });

    UI.generateZip.addEventListener('click', async () => {
      if(!App.pdfBytes) return alert("Upload PDF first.");
      const zip = new JSZip();
      
      const btnText = UI.generateZip.textContent;
      UI.generateZip.textContent = "Generating...";

      for(let i=0; i<App.students.length; i++) {
        const s = App.students[i];
        const bytes = await generatePDF(s);
        const name = `${s.Name || 'Certificate'}-${i+1}.pdf`;
        zip.file(name, bytes);
      }
      
      const content = await zip.generateAsync({type:"blob"});
      saveAs(content, "certificates.zip");
      UI.generateZip.textContent = btnText;
    });

    /** 8. Save/Load Config **/
    UI.saveConfig.addEventListener('click', () => {
      const config = { fields: App.placeholders };
      const blob = new Blob([JSON.stringify(config)], {type: "application/json"});
      saveAs(blob, "cert-template-config.json");
    });

    UI.loadConfig.addEventListener('click', () => UI.configInput.click());
    
    UI.configInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const text = await file.text();
      try {
        const conf = JSON.parse(text);
        if(conf.fields) {
          // Clear current
          Object.values(App.placeholders).forEach(p => p.element.remove());
          App.placeholders = {};
          
          // Load new
          for(const [key, val] of Object.entries(conf.fields)) {
            createOrUpdatePlaceholder(key, val.xPercent, val.yPercent, val);
          }
          // Ensure these keys exist in the field list
          Object.keys(conf.fields).forEach(k => {
             if(!App.fields.includes(k)) App.fields.push(k);
          });
          renderFieldList();
          UI.fieldsContainer.classList.remove('hidden');
        }
      } catch(err) { alert("Invalid config file"); }
    });

  </script>
</body>
</html>
