<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>
  eruda.init();
</script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mobile PDF Editor</title>
<style>
 body { margin: 0; background: #121212; color: #e0e0e0; font-family: Arial; }
 .container { padding: 10px; }
 h3 { text-align: center; margin: 10px 0 20px; }
 button { width: 100%; padding: 10px; margin: 6px 0; border: none; border-radius: 8px; background: #1e88e5; color: white; font-size: 15px; }
 input, select { width: 100%; padding: 8px; margin: 5px 0; background: #1e1e1e; border: 1px solid #333; border-radius: 6px; color: #eee; }
 #previewWrapper { position: relative; margin-top: 12px; }
 #pdfPreview { width: 100%; border-radius: 10px; }
 .text-item { background: #1e1e1e; border: 1px solid #333; padding: 8px; border-radius: 8px; margin-bottom: 8px; }
 .text-overlay { position: absolute; padding: 3px 5px; border-radius: 4px; background: rgba(0,0,0,0.7); color: white; font-size: 14px; }
 .row { display: flex; gap: 6px; }
 .half { width: 50%; }
</style>
</head>
<body>
<div class="container">
 <h3>Mobile PDF Editor</h3>
 <input type="file" id="pdfFile" accept="application/pdf" />
 <button id="addTextBtn" disabled>+ Add Text</button>
 <button id="exportBtn" disabled>Export PDF</button>

 <div id="previewWrapper"><canvas id="pdfPreview"></canvas></div>

 <div id="textItems"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
let pdfDoc = null, scale = 1;
const preview = document.getElementById("pdfPreview");
const ctx = preview.getContext("2d");
let overlays = [];

pdfFile.addEventListener("change", async e => {
 const file = e.target.files[0]; if (!file) return;
 const buf = await file.arrayBuffer();
 pdfDoc = await pdfjsLib.getDocument({ data: buf }).promise;
 const page = await pdfDoc.getPage(1);
 const vp = page.getViewport({ scale: 1 });
 scale = preview.clientWidth / vp.width;
 const svp = page.getViewport({ scale });
 preview.width = svp.width; preview.height = svp.height;
 await page.render({ canvasContext: ctx, viewport: svp }).promise;
 addTextBtn.disabled = false; exportBtn.disabled = false;
});

function refreshOverlay(id) {
 const txt = document.getElementById(`txt_${id}`).value;
 const fs = document.getElementById(`fs_${id}`).value;
 const clr = document.getElementById(`clr_${id}`).value;
 const ox = document.getElementById(`x_${id}`).value;
 const oy = document.getElementById(`y_${id}`).value;
 const ov = document.getElementById(`ov_${id}`);
 ov.textContent = txt;
 ov.style.fontSize = fs + "px";
 ov.style.color = clr;
 ov.style.left = ox + "px";
 ov.style.top = oy + "px";
}

addTextBtn.addEventListener("click", () => {
 const id = Date.now();
 const box = document.createElement("div");
 box.className = "text-item";
 box.innerHTML = `
   <label>Text</label>
   <input id="txt_${id}" placeholder="text" oninput="refreshOverlay(${id})" />
   <div class="row"><div class="half">
     <label>Size</label><input id="fs_${id}" type="number" value="16" oninput="refreshOverlay(${id})" />
   </div><div class="half">
     <label>Color</label><input id="clr_${id}" type="color" value="#ffffff" oninput="refreshOverlay(${id})" />
   </div></div>
   <div class="row"><div class="half">
     <label>X</label><input id="x_${id}" type="number" value="50" oninput="refreshOverlay(${id})" />
   </div><div class="half">
     <label>Y</label><input id="y_${id}" type="number" value="50" oninput="refreshOverlay(${id})" />
   </div></div>
   <label>Anchor</label>
   <select id="anc_${id}"><option value="left">Left</option><option value="center">Center</option><option value="right">Right</option></select>
   <button onclick="removeText(${id})">Delete</button>`;
 document.getElementById("textItems").appendChild(box);

 const ov = document.createElement("div");
 ov.className = "text-overlay";
 ov.id = `ov_${id}`;
 ov.textContent = "Text";
 ov.style.left = "50px";
 ov.style.top = "50px";
 ov.dataset.id = id;
 previewWrapper.appendChild(ov);
 overlays.push(ov);
 enableDrag(ov);
});

function removeText(id) {
 overlays = overlays.filter(o => {
   if (o.dataset.id == id) { o.remove(); return false; }
   return true;
 });
 document.getElementById(`txt_${id}`).parentElement.remove();
}

function enableDrag(el) {
 let ox = 0, oy = 0;
 el.addEventListener("touchstart", e => {
   const t = e.touches[0];
   ox = t.clientX - el.offsetLeft; oy = t.clientY - el.offsetTop;
 });
 el.addEventListener("touchmove", e => {
   const t = e.touches[0];
   el.style.left = (t.clientX - ox) + "px";
   el.style.top = (t.clientY - oy) + "px";
   const id = el.dataset.id;
   document.getElementById(`x_${id}`).value = parseInt(el.style.left);
   document.getElementById(`y_${id}`).value = parseInt(el.style.top);
 });
}

exportBtn.addEventListener("click", async () => {
 const buf = await pdfFile.files[0].arrayBuffer();
 const pdf = await PDFLib.PDFDocument.load(buf);
 const p = pdf.getPage(0);
 const { width, height } = p.getSize();

 overlays.forEach(o => {
   const id = o.dataset.id;
   const txt = document.getElementById(`txt_${id}`).value;
   const fs = parseInt(document.getElementById(`fs_${id}`).value);
   const clr = document.getElementById(`clr_${id}`).value;
   let x = parseInt(document.getElementById(`x_${id}`).value) / scale;
   let y = height - (parseInt(document.getElementById(`y_${id}`).value) / scale);

   p.drawText(txt, {
     x,
     y,
     size: fs,
     color: PDFLib.rgb(
       parseInt(clr.substr(1,2),16)/255,
       parseInt(clr.substr(3,2),16)/255,
       parseInt(clr.substr(5,2),16)/255
     )
   });
 });

 const out = await pdf.save();
 const link = document.createElement("a");
 link.href = URL.createObjectURL(new Blob([out]));
 link.download = "edited.pdf";
 link.click();
});
</script>
</body>
</html>
