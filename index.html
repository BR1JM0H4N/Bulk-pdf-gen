<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>
  eruda.init();
</script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mobile PDF Editor</title>
<style>
 body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
 .container { padding: 12px; }
 #previewWrapper { position: relative; width: 100%; }
 #pdfPreview { width: 100%; border: 1px solid #ddd; border-radius: 8px; }
 .text-overlay { position: absolute; padding: 4px 6px; background: rgba(255,255,255,0.6); border: 1px solid #333; border-radius: 4px; cursor: move; }
 .controls { margin-top: 12px; }
 .text-item { border: 1px solid #ddd; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
 button { padding: 10px 14px; border: none; border-radius: 8px; background: #007bff; color: white; }
 input, select { width: 100%; padding: 8px; margin: 6px 0; }
</style>
</head>
<body>
<div class="container">
 <h3>Mobile PDF Editor</h3>
 <input type="file" id="pdfFile" accept="application/pdf" />
 <button id="addTextBtn" disabled>+ Add Text</button>
 <button id="exportBtn" disabled>Export PDF</button>

 <div id="previewWrapper">
   <canvas id="pdfPreview"></canvas>
 </div>

 <div class="controls" id="textItems"></div>
</div>

<!-- FIX: Load pdf.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<!-- pdf-lib -->
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
let pdfDoc = null;
let scale = 1;
let overlays = [];
const pdfPreview = document.getElementById("pdfPreview");
const ctx = pdfPreview.getContext("2d");

// Load PDF
pdfFile.addEventListener("change", async (e) => {
 const file = e.target.files[0];
 if (!file) return;
 const arrayBuffer = await file.arrayBuffer();

 pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
 const page = await pdfDoc.getPage(1);
 const viewport = page.getViewport({ scale: 1 });
 scale = pdfPreview.clientWidth / viewport.width;
 const scaledViewport = page.getViewport({ scale });
 pdfPreview.width = scaledViewport.width;
 pdfPreview.height = scaledViewport.height;

 const renderContext = { canvasContext: ctx, viewport: scaledViewport };
 await page.render(renderContext).promise;

 addTextBtn.disabled = false;
 exportBtn.disabled = false;
});

// Add text UI
addTextBtn.addEventListener("click", () => {
 const id = Date.now();
 const div = document.createElement("div");
 div.className = "text-item";
 div.innerHTML = `
   <label>Text</label>
   <input type="text" id="txt_${id}" placeholder="Enter text" />
   <label>Font Size</label>
   <input type="number" id="fs_${id}" value="16" />
   <label>Color</label>
   <input type="color" id="clr_${id}" value="#000000" />
   <label>X Position</label>
   <input type="number" id="x_${id}" value="50" />
   <label>Y Position</label>
   <input type="number" id="y_${id}" value="50" />
   <label>Anchor</label>
   <select id="anc_${id}">
     <option value="left">Left</option>
     <option value="center">Center</option>
     <option value="right">Right</option>
   </select>
   <button onclick="removeText(${id})">Delete</button>
 `;
 textItems.appendChild(div);

 // create overlay
 const overlay = document.createElement("div");
 overlay.className = "text-overlay";
 overlay.id = `ov_${id}`;
 overlay.textContent = "New Text";
 overlay.style.left = "50px";
 overlay.style.top = "50px";
 overlay.dataset.id = id;

 enableDrag(overlay);
 previewWrapper.appendChild(overlay);
 overlays.push(overlay);
});

function removeText(id) {
 overlays = overlays.filter(o => {
   if (o.dataset.id == id) { o.remove(); return false; }
   return true;
 });
 document.getElementById(`txt_${id}`).parentElement.remove();
}

function enableDrag(el) {
 let offsetX = 0, offsetY = 0;
 el.addEventListener("touchstart", e => {
   const t = e.touches[0];
   offsetX = t.clientX - el.offsetLeft;
   offsetY = t.clientY - el.offsetTop;
 });
 el.addEventListener("touchmove", e => {
   const t = e.touches[0];
   el.style.left = (t.clientX - offsetX) + "px";
   el.style.top = (t.clientY - offsetY) + "px";
   const id = el.dataset.id;
   document.getElementById(`x_${id}`).value = parseInt(el.style.left);
   document.getElementById(`y_${id}`).value = parseInt(el.style.top);
 });
}

// Export PDF
exportBtn.addEventListener("click", async () => {
 const file = pdfFile.files[0];
 const arrayBuffer = await file.arrayBuffer();
 const pdf = await PDFLib.PDFDocument.load(arrayBuffer);
 const page = pdf.getPage(0);
 const { width, height } = page.getSize();

 overlays.forEach(el => {
   const id = el.dataset.id;
   const txt = document.getElementById(`txt_${id}`).value;
   const fs = parseInt(document.getElementById(`fs_${id}`).value);
   const clr = document.getElementById(`clr_${id}`).value;
   const x = parseInt(document.getElementById(`x_${id}`).value) / scale;
   const y = height - parseInt(document.getElementById(`y_${id}`).value) / scale;

   page.drawText(txt, {
     x,
     y,
     size: fs,
     color: PDFLib.rgb(
       parseInt(clr.substr(1, 2), 16) / 255,
       parseInt(clr.substr(3, 2), 16) / 255,
       parseInt(clr.substr(5, 2), 16) / 255
     )
   });
 });

 const pdfBytes = await pdf.save();
 const blob = new Blob([pdfBytes], { type: "application/pdf" });
 const link = document.createElement("a");
 link.href = URL.createObjectURL(blob);
 link.download = "edited.pdf";
 link.click();
});
</script>
</body>
</html>
